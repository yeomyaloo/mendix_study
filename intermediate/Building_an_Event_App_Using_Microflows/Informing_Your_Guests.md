# 학습목표
이 모듈을 완료하면 다음을 수행할 수 있습니다:
- 뉴스레터를 만들고 보내는 데 사용할 수 있는 다양한 기능 설명
- 예약된 이벤트 생성
- 리스트 반복 처리
- 필터 기능을 사용하여 리스트에서 특정 객체 찾기
- 정렬된 정보 가져오기
- 배치 처리 작업

# 뉴스레터 만들
- 이전 모듈에서는 사람들이 티켓을 구매하고 뉴스레터를 받기를 원하는 경우 체크박스를 선택할 수 있는 옵션을 만들었습니다. 이벤트에 대한 사람들의 관심을 끌기 위해

# 뉴스레터 보내기
## 1. 이벤트 관리자가 자동으로 기능을 처리하는 방법
이벤트 관리자는 뉴스레터를 작성하고 티켓을 구매한 사람들에게 보낼 수 있어야 합니다. 우리는 앱이 매일 뉴스레터가 보낼 준비가 되어 있는지 확인하고, 만약 있다면 자동으로 보내도록 하려고 합니다. 
### 1.1 뉴스레터 보내는 작업에 필요한 기능 
**이 기능을 만들기 위해 필요한 기능을 먼저 살펴보겠습니다:**
- 스케줄된 이벤트
- 루프
- 집계 함수
- 배치

#### 1.1.1 스케줄된 이벤트
- 스케줄된 이벤트를 사용하면 앱이 특정 시간에 마이크로플로우를 실행하도록 할 수 있습니다. 또한 시간, 일 또는 분 단위로 주어진 간격에 따라 반복 실행할 수 있습니다.
  - 예를 들어, 1년의 간격이 주어지면 정확히 매년이 아닌 365일마다 트리거됩니다.
  - 이는 월간 간격에도 동일하게 적용되며, 1개월의 간격을 주면 마이크로플로우는 30일마다 트리거됩니다.
- 스케줄된 이벤트는 활성화된 경우에만 마이크로플로우가 실행됩니다. 모델러에서 구성된 설정은 Studio Pro 또는 Eclipse에서 실행할 때만 적용됩니다. 프로덕션 환경에서는 스케줄된 이벤트를 적절한 도구(클라우드 포털, Windows 서비스 콘솔 등)를 통해 활성화하거나 비활성화할 수 있습니다.

#### 1.1.2 루프(Loops)
- 루프는 객체 목록을 반복 처리하는 데 사용됩니다. 목록의 각 객체에 대해 루프 내의 흐름이 실행됩니다.
- 루프는 시작 및 종료 이벤트를 제외한 모든 일반적인 마이크로플로우 요소를 포함할 수 있습니다.
- 또한 루프는 중단(break) 이벤트와 계속(continue) 이벤트를 포함할 수 있습니다.
  - 중단 이벤트는 목록에 대한 반복을 중지하고, 계속 이벤트는 현재 반복만 중지하고 다음 객체의 반복을 시작합니다.
- 루프가 반복하는 객체는 반복자(iterator)라고 하며, 마이크로플로우의 입력 파라미터와 동일한 방식으로 나타납니다.
![image](https://github.com/user-attachments/assets/1cd750f4-6431-4f98-87e2-7fd135f7552d)

#### 1.1.3 집계 함수(Aggregate functions)
- `Aggregate List`는 목록의 객체들에 대해 최대값, 최소값, 합계, 평균 및 총 객체 수와 같은 집계 값을 계산하는 데 사용됩니다.
- 집계 함수는 조회(retrieve)와 함께 사용할 수도 있습니다.
- 데이터베이스에서 조회를 수행하면 데이터베이스로 쿼리가 전송됩니다.
- 데이터베이스에서 조회한 후 집계 목록 작업을 수행하면 최적화된 조회 결과를 얻을 수 있습니다.

아래 예에서는 조회 및 `Count` 활동을 배치하면 데이터베이스에 단 하나의 최적화된 쿼리가 전송됩니다.
![image](https://github.com/user-attachments/assets/02d96c87-238a-4be1-bfa3-48f2850302ac)

#### 1.1.4 배치(Batches)
- 배치는 대량의 데이터를 처리할 때 사용됩니다.
- 배치는 전체 데이터 세트를 더 작은 부분으로 나누어 한 번에 하나의 레코드 하위 집합을 업데이트할 수 있게 합니다.
- `Custom range` 옵션을 사용하여 배치 조회를 구성할 수 있으며, 이를 통해 배치의 크기를 제한하여 애플리케이션이 너무 많은 레코드를 메모리에 저장하지 않도록 할 수 있습니다.
  - 이를 통해 성능에 미치는 부정적인 영향을 방지할 수 있습니다.
  - 또한, 오프셋(offset)을 사용하여 테이블에서 조회를 시작할 위치를 구성할 수 있습니다.

## 2. 엔터티 생성 및 기본 설정
### 2.1 시나리오
- 이벤트 관리자는 티켓을 구매한 사람들에게 뉴스레터를 보내야 합니다.
- 이벤트 관리자가 뉴스레터를 작성할 수 있도록 하고, 뉴스레터는 뉴스레터 수신을 원한다고 체크한 모든 사용자에게 이메일로 전송되도록 해야 합니다.
- 이를 위해 이벤트 관리자가 뉴스레터를 작성할 수 있도록 `Newsletter` 엔터티를 추가해야 합니다.

### 2.2 EventManager의 속성 변경 및 추가 작업
- 이벤트 관리자는 뉴스레터에 대한 제목과 내용을 입력하고 싶어합니다.
- 따라서 `Title`과 `Message` 속성을 만들어야 하며
- `Message`는 무제한 문자열로 설정해야 합니다.
- 또한, 뉴스레터가 사용자에게 전송되었는지 추적해야 하므로 `IsSent`라는 불린(Boolean) 속성을 추가해야 합니다.
- 마지막으로, `createdDate` 저장을 체크해야 합니다.

### 2.3 엔티티 추가와 연관 관게 추가
- 뉴스레터는 이메일로 전송되므로, `Email` 엔터티를 생성하고
- `Title`, `Message`, `EmailAddress` 속성을 추가합니다.
- 또한, 하나의 뉴스레터가 여러 이메일을 가질 수 있도록 `Email`과 `Newsletter` 간의 관계를 추가합니다.

### 2.4 뉴스레터 관련 뷰 페이지 생성 
- 도메인 모델에 엔터티를 설정한 후, 해당 엔터티의 인스턴스를 유지 관리하고 볼 수 있는 프론트 엔드를 만들어야 합니다.
- 이벤트 관리자가 새로운 뉴스레터를 작성하고 볼 수 있도록 `Overview` 페이지와 `NewEdit` 페이지를 생성합니다.

### 2.5 이미 발송된 뉴스 레터가 수정되는 것을 막는 작업
이벤트 관리자가 이미 전송된 뉴스레터는 수정할 수 없도록 해야 합니다.
1. 뉴스레터의 `NewEdit` 페이지로 이동합니다.
2. `Title`과 `Message` 속성에 대해 `IsSent = false` 조건에 따라 수정 가능 여부를 설정합니다. `IsSent` 값은 자동으로 설정되므로 페이지에서 제거할 수 있습니다.

### 2.6 전송된 이메일 확인 뷰 페이지 생성
- 또한, 방문자에게 전송된 이메일을 확인할 수 있도록 이메일을 볼 수 있는 `Overview` 페이지를 만듭니다.
- 설정이 완료되면 이벤트 관리자의 탐색에 해당 `Overview` 페이지를 추가해야 합니다.
  - 이벤트 관리자가 모든 페이지에 접근할 수 있도록 하세요.

### 2.7 보안 설정
- 생성된 `Email` 객체는 뉴스레터가 생성되고 수정되는 곳에서만 볼 수 있도록 설정해야 합니다.
- `Email_Overview` 페이지에서 `Edit` 버튼의 제목을 `View`로 변경하고, `New` 버튼을 제거하는 것이 좋습니다.

### 2.8 이메일 수신거부 방문자를 위한 최신 뉴스레터 뷰 페이지 생성
- 이메일을 수신하지 않으려는 방문자를 위해 최신 뉴스레터를 보여주는 페이지도 만들어야 합니다.
- 최신 뉴스레터를 데이터뷰에서 열기 위한 마이크로플로우를 생성합니다. 마이크로플로우는 아래와 같은 형태가 될 것입니다.
![image](https://github.com/user-attachments/assets/e2ba512b-240e-476f-9d20-f396192e2061)
- 여기서 `CreatedDate`를 기준으로 최신 뉴스레터를 조회합니다. `CreatedDate`를 추가하면 이 속성을 내림차순으로 정렬하여 최신 뉴스레터를 가져올 수 있습니다. 뉴스레터가 있으면 해당 정보를 보여주고, 없으면 뉴스레터가 없다는 메시지를 제공합니다. `Newsletter_View` 페이지에서는 제목과 내용만 표시합니다.
![image](https://github.com/user-attachments/assets/2db53abd-49c9-4d12-8226-c76f53f8181b)

### 자동으로 뉴스레터 보내기 설정
기본 설정이 완료되었으니 이제 뉴스레터가 자동으로 전송되도록 설정할 차례입니다.

##  3. 예약 이벤트 생성(Creating a Scheduled Event)
### 3.1 예약 이벤트 생성 시 주의사항
- 이벤트 관리자가 뉴스레터를 작성하면, 해당 뉴스레터가 특정 시간에 방문자에게 이메일로 전송되도록 해야 합니다.
- 이를 자동으로 처리하여, 이벤트 관리자가 뉴스레터가 언제 또는 어떻게 발송될지 걱정하지 않도록 합니다.
- 이를 위해 예약 이벤트(Scheduled Event)를 생성할 수 있습니다.
- 예약 이벤트는 App Explorer에서 다른 문서와 마찬가지로 생성할 수 있습니다.

### 3.2 예약 이벤트 생성 절차
1. 예약 이벤트를 생성하고, 이를 `SendNewsletters`라고 이름 짓습니다.
2. `Select`를 클릭하고 `SCE_Newsletter_Send`라는 새 마이크로플로우를 생성합니다.
3. 간격(Interval)을 1일로 설정합니다. 이는 내일부터 매일 오전 09:00:00에 예약 이벤트와 `SCE_Newsletter_Send` 마이크로플로우가 트리거된다는 의미입니다.
![image](https://github.com/user-attachments/assets/cf3e12be-1387-4193-bc83-43a2d8e03e34)


## 4. 루프 생성(Creating a Loop)
이제 예약된 이벤트에 의해 트리거되는 마이크로플로우를 설정해 보겠습니다.

### 4.1 `SCE_Newsletter_Send` 마이크로플로우 열기
- 이 마이크로플로우의 목적은 이전에 전송되지 않은 모든 뉴스레터를 발송하는 것입니다.
- 뉴스레터는 이메일을 통해 전송되지만, 뉴스레터를 구독한 방문자에게만 보내고 싶습니다.

### 4.2 전송되지 않은 뉴스레터 필터링
- 먼저, 데이터베이스에서 모든 뉴스레터를 검색해야 합니다. 그러나 전송되지 않은 뉴스레터만을 보내기 위해 `Filter list` 작업을 사용하여 `IsSent` Boolean 값을 기준으로 뉴스레터 목록을 필터링할 수 있습니다.
- 이 필터링된 목록을 `NewsletterListNotSent`라고 명명합니다.

### 4.3 루프를 사용하여 뉴스레터 처리
- 필터링된 뉴스레터 목록이 있으므로, 루프(Loop)를 사용하여 해당 뉴스레터를 처리해야 합니다.
- 마이크로플로우에 `Loop` 동작을 넣고 `NewsletterListNotSent`를 반복(iterate)하도록 설정합니다.

### 4.4 하위 마이크로플로우 호출
- 마이크로플로우를 더욱 이해하기 쉽게 하기 위해, 뉴스레터를 보내는 모든 논리를 하위 마이크로플로우에 넣습니다.
- 루프 내에서 마이크로플로우를 호출하고, 이를 `SUB_Email_CreateAndSend`라고 명명합니다.
  - 이 마이크로플로우는 다음 섹션에서 채워질 예정입니다.

### 4.5 뉴스레터 전송 후 `IsSent` 값 변경
- 뉴스레터를 보낸 후에는 `IsSent` Boolean 값을 `true`로 설정하여 다시 전송되지 않도록 해야 합니다.
-  `Change` 작업을 사용하여 `IteratorNewsletter`의 `isSent` 값을 `true`로 변경합니다.

### 4.6 마이크로플로우 예시
마이크로플로우는 다음과 같아야 합니다:
```plaintext
1. 데이터베이스에서 뉴스레터 목록 검색
2. Filter list로 전송되지 않은 뉴스레터 필터링
3. 루프를 통해 필터링된 뉴스레터 처리
4. 하위 마이크로플로우 호출 (SUB_Email_CreateAndSend)
5. 뉴스레터 전송 후 `IsSent` 값 변경
```
![image](https://github.com/user-attachments/assets/57e9bc9d-6947-454b-9634-83a2ee161135)

## 5. 이메일 발송을 위한 루프 및 배치 처리
이전 단계에서 뉴스레터를 보내기 위한 루프를 만들었으며, 이제 `SUB_Email_CreateAndSend` 마이크로플로우를 설정하겠습니다. 이 마이크로플로우는 각 뉴스레터에 대해 호출됩니다.

### 5.1 `SUB_Email_CreateAndSend` 마이크로플로우 설정
- `Newsletter` 객체가 매개변수로 추가되어야 합니다.
- 빈 `SUB_Email_CreateAndSend` 마이크로플로우를 열고 `Newsletter` 매개변수를 추가합니다.
- "매개변수 매핑을 새로 고쳐야 합니다" 오류가 나타나면, 오류를 두 번 클릭하여 루프 내의 하위 마이크로플로우를 열고 `IteratorNewsletter`를 인수로 전달합니다.

### 5.2 배치(Batch) 사용
뉴스레터를 구독한 방문자 수가 많을 경우, 성능 문제가 발생할 수 있으므로 배치 처리가 필요합니다. 이를 위해 `Limit`과 `Offset` 변수를 설정합니다.
- **Limit 변수**: 처리할 배치 크기를 나타냅니다. 예를 들어, `500`으로 설정하면 한 번에 500명의 방문자를 처리합니다.
- **Offset 변수**: 초기 값이 `0`인 정수형 변수로, 검색을 시작할 위치를 나타냅니다. 예를 들어, 오프셋이 `0`이면 처음 500개의 객체를 검색하고, 오프셋이 `500`이면 다음 500개의 객체를 검색합니다.

### 5.3 방문자 검색
- `retrieve` 작업을 사용하여 방문자를 검색합니다.
- `Custom` 범위를 선택하고, `Limit`과 `Offset` 변수를 사용하여 데이터를 검색합니다.
- 검색된 `VisitorList`를 반복하는 루프를 추가합니다.

### 5.4 배치 로직 완료
- 각 배치에서 500명 이상의 방문자를 처리해야 하는지 확인하려면, `Aggregate List` 작업을 사용하여 `Count` 함수를 이용해 방문자 수를 계산합니다.
- 방문자 수가 500명보다 적으면 더 이상 배치를 처리할 필요가 없으며, 그렇지 않으면 `Offset` 변수를 `$Offset + 500`으로 증가시킵니다.

### 5.5 루프 내 논리 처리
- 각 방문자에 대해 방문자가 뉴스레터를 구독했는지 확인합니다.
- 구독하지 않은 경우 `continue` 이벤트를 사용하고, 구독한 경우 이메일을 생성하고 전송하는 로직을 하위 마이크로플로우로 분리합니다.

### 5.6 `SUB_Email_Create` 마이크로플로우 생성
- 새로운 마이크로플로우를 생성하고, 이를 `SUB_Email_Create`라고 부릅니다.
- 이 마이크로플로우는 `Newsletter`와 `Visitor` 객체를 입력 매개변수로 받습니다.
- `Newsletter` 객체를 기반으로 이메일을 생성하고, `Visitor` 객체의 `Email` 속성을 사용하여 이메일 주소를 입력합니다.
- 이메일 객체를 마이크로플로우로 전달합니다.

### 5.7 `SUB_Email_CreateAndSend` 오류 해결
![image](https://github.com/user-attachments/assets/67fbb66b-9924-4d86-8cad-0fd5409aaf42)
- 오류를 두 번 클릭하여 `SUB_Email_CreateAndSend`로 이동하고, 하위 마이크로플로우를 두 번 클릭하여 오류를 해결합니다.

### 5.8 이메일 전송 마이크로플로우 생성
- 이메일을 실제로 전송할 새로운 마이크로플로우를 생성하고, 입력 매개변수로 `Email`을 전달합니다.
- 이 마이크로플로우에서는 가상으로 이메일을 전송합니다. 실제 이메일을 보내려면 Mendix Marketplace에서 제공하는 이메일 모듈을 사용할 수 있습니다.
- ![image](https://github.com/user-attachments/assets/8817f3e3-cd53-43b8-8fd9-f90479c90e3f)







