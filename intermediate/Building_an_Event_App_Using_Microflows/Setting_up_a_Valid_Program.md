# 서브 마이크로플로우 사용하기
### 마이크로플로우와 서브마이크로플로우
- 마이크로플로우는 그 사용 방법과 무수한 기능 덕분에 매우 복잡해질 수 있습니다.
  - 이를 통해 복잡한 프로세스를 구축할 수 있습니다. 그렇다면 이러한 마이크로플로우를 어떻게 제어할 수 있을까요?
### 마이크로플로우 제어를 위한 서브마이크로플로우
- Mendix에서는 마이크로플로우가 다른 마이크로플로우에 의해 호출될 수 있습니다.
- 다른 마이크로플로우에 의해 호출되는 마이크로플로우를 서브 마이크로플로우(sub-microflow)라고 합니다.
- 이는 상위 마이크로플로우의 하위 섹션입니다.

### 서브 마이크로플로우의 도움
- 서브 마이크로플로우를 사용하면 가독성을 개선할 수 있으며, 복잡한 마이크로플로우의 (일부) 재사용과 유지 관리가 더 쉬워집니다.
- 재사용성을 최대한 활용하기 위해, 서브 마이크로플로우가 수행해야 할 작업과 이를 사용할 위치를 결정해야 합니다.
- 이를 통해 서브 마이크로플로우가 요구되는 활동을 수행할 수 있도록 어떤 정보를 전달해야 하는지 알 수 있습니다.
- 입력 매개변수가 많을수록 의존성이 증가하며, 마이크로플로우의 재사용이 어려워질 수 있습니다.

## 1. ProgramItem 엔티티 생성하기
프로그램을 생성하기 위해, `EventManagement` 모듈의 도메인 모델에 새로운 엔티티를 추가해야 합니다. 이 엔티티를 `ProgramItem`이라고 부릅시다.

### 1.1 `ProgramItem` 속성
`ProgramItem`은 다음 속성들을 가져야 합니다:
- (속성 목록을 여기에 추가하세요)
![image](https://github.com/user-attachments/assets/6db83ef9-eb31-4ba7-b322-08540f1405ef)

### 1.2 참조
또한, 다음과 같은 1-* 참조가 있어야 합니다:
- (참조 목록을 여기에 추가하세요)
![image](https://github.com/user-attachments/assets/0d671336-2a9c-4ac6-8bf0-391a4367ecf9)

### 1.3 도메인 모델
도메인 모델은 다음과 유사해야 합니다:
(도메인 모델 그림을 여기에 추가하세요)
![image](https://github.com/user-attachments/assets/5184f169-b083-43a2-a81b-4c1a4f3dd3a4)

### 1.4 페이지 생성
이제, 이전에 했던 것처럼 `ProgramItem` 엔티티의 개요 및 NewEdit 페이지를 생성하세요.
![image](https://github.com/user-attachments/assets/a44d34cd-deb9-47dd-8a3f-46dd8e3fd133)

### 1.5 탐색 항목 추가
그 다음, Program 개요 페이지로 연결되는 탐색 항목을 추가합니다. 이렇게 하면 이벤트 관리자가 프로젝트 탐색에서 `ProgramItem` 객체를 유지할 수 있습니다.
![image](https://github.com/user-attachments/assets/dd8a8402-6f66-4c76-94ea-5a3bd09813a2)

### 1.6 접근 권한 설정
마지막으로, 엔티티 및 페이지에 적절한 접근 권한 규칙을 설정해야 합니다. `EventManager` 역할에 접근을 허용하되, 방문자 수는 프로그램마다 자동으로 유지되므로 `EventManager`가 실수로 변경하지 않도록 해야 합니다. 이벤트 관리자는 새 객체를 생성하고 기존 객체를 삭제할 수 있어야 합니다.
![image](https://github.com/user-attachments/assets/5447daa9-2e6d-4829-9735-8528b34463f7)

## 2. 프로그램 유효성 검사
- 프로그램 항목을 유지 관리하는 페이지를 설정한 후, 이벤트 관리자가 입력할 프로그램 정보에 유효성 검사를 추가하고 싶습니다.
- 이를 위해, 도메인 모델의 `ProgramItem` 엔티티에 커밋 전 이벤트를 추가하세요.
  - 참고로, Rapid Developer 학습 경로의 Event Handlers 강의를 검토할 수 있습니다.
- 이벤트 핸들러를 생성할 때 ‘마이크로플로우가 false를 반환하면 오류를 발생시킵니다’를 체크 해제해야 합니다.
  - 이는 기본 오류 메시지가 아닌 **자체 알림을 제공**하고자 하기 때문입니다.
  - 만약 자체 오류 메시지를 사용하지 않는 다른 시나리오가 있다면 이 체크박스를 체크한 상태로 두어도 됩니다.
- 이제 이벤트 핸들러를 생성한 후, 이 이벤트에 해당하는 마이크로플로우 (`BCO_ProgramItem`)를 생성합니다.
![image](https://github.com/user-attachments/assets/0490b62d-144c-425a-9d4f-cbb2f4874780)
![image](https://github.com/user-attachments/assets/15b8d203-a823-4efc-89ea-48a7dfebe634)

### 2.1 필드 유효성 검사
먼저, 아래 항목들이 입력되었는지 확인해야 합니다:
- 제목이 입력되었나요?
- 설명이 입력되었나요?
- 시작 시간이 입력되었나요?
- 종료 시간이 입력되었나요?
- 아티스트가 선택되었나요?
- 날짜가 선택되었나요?
- 무대가 선택되었나요?

#### 2.1.1 필드 유효성 검사 마이크로플로우
유효성 검사를 위한 항목을 추가하기 전에, Boolean 변수를 생성하여 처음에는 `true`로 설정하고, 항목 필드가 비어 있을 경우 `false`로 변경하세요. 해당 항목이 채워져야 함을 나타내는 유효성 검증 피드백을 추가하는 것을 잊지 마세요.
각 필드를 검증하고 마이크로플로우는 다음과 같은 형태가 될 것입니다:
![image](https://github.com/user-attachments/assets/e5d883eb-87cf-41fa-b3ad-be6d4235641b)

### 2.2 추가 유효성 검사
모든 필드가 비어 있지 않은 것을 확인한 후, 다음 항목들도 검증합니다:
- 시작 시간이 종료 시간보다 작은가요?
- 시작 시간과 종료 시간이 선택된 날짜의 시간 내에 있는가요?

다음과 같은 결정을 추가하여 시작 시간이 선택된 날짜 내에 있는지 검증합니다:
- `$ProgramItem/StartTime > $ProgramItem/EventManagement.ProgramItem_Day/EventManagement.Day/StartDate`
- `$ProgramItem/StartTime < $ProgramItem/EventManagement.ProgramItem_Day/EventManagement.Day/EndDate`

#### 2.2.1 종료 시간을 검증하는 마이크로플로우
- 마지막으로, 종료 시간이 선택된 날짜 내에 있는지 검증합니다.
- 모든 유효성 검사를 확인하는 마이크로플로우를 완료하면, 아래와 같은 큰 마이크로플로우가 될 것입니다.

### 2.3 접근 권한 설정
- 엔티티 및 페이지에 적절한 접근 권한 규칙을 설정해야 합니다.
- `EventManager` 역할에 접근을 허용하되, 방문자 수는 프로그램마다 자동으로 유지되므로 `EventManager`가 실수로 변경하지 않도록 해야 합니다.
  - 이벤트 관리자는 새 객체를 생성하고 기존 객체를 삭제할 수 있어야 합니다.
![image](https://github.com/user-attachments/assets/1ee7a24f-eac6-4826-8201-f74be6e20547)

## 3. 가독성 최적화
### 3.1 서브 마이크로플로우를 이용한 가독성, 재사용성, 유지 관리 개선 방법
- 아마도 이미 경험하셨겠지만, 유효성 검사 마이크로플로우가 상당히 길어졌습니다. 하지만 이러한 모든 단계가 필요합니다.
- 그렇다면 가독성, 재사용성, 유지 관리를 개선하기 위해 무엇을 할 수 있을까요? 서브 마이크로플로우를 활용할 수 있습니다.
- 유효성 검사 마이크로플로우의 일부를 추출하는 것이 얼마나 쉬운지 살펴보겠습니다.

### 3.3 서브 마이크로플로우 생성
- 어디서 논리적 분리를 할 수 있을지 확인하여 추출할 부분을 결정합니다.
- 이상적으로는 먼저 모든 필수 필드가 입력되었는지 확인한 후, 종속성을 검증하는 단계로 넘어가야 합니다.
- 이것이 바로 서브 마이크로플로우를 생성할 시점입니다.
  - 변수를 선택하고 필수 필드에 대한 모든 검사를 선택합니다.
  - 그런 다음 선택한 부분에서 마우스 오른쪽 버튼을 클릭하고 '서브 마이크로플로우 추출(Extract sub-microflow)'을 선택합니다.
  - 서브 마이크로플로우에 'VAL_ProgramItem_RequiredInfo'와 같은 적절한 이름을 부여합니다.
  - 'VAL' 접두사는 검증 목적으로 사용되는 (서브-)마이크로플로우에 사용되며, 다른 서브 마이크로플로우는 'SUB' 접두사를 사용합니다.

**참고:** 선택한 아티팩트에 따라 서브 마이크로플로우를 추출할 수 없다는 알림이 표시되는 경우가 있을 수 있습니다. 이는 선택한 항목에 파라미터와/또는 시작 이벤트가 포함되어 있기 때문일 수 있습니다. 종료 이벤트를 선택할 수도 없습니다. 서브 마이크로플로우를 생성할 때 이러한 항목을 선택하지 않도록 주의하세요.

유효성 검사 마이크로플로우의 두 번째 부분에 대해서도 시도해 보세요. 이를 'VAL_ProgramItem_Dependencies'라는 서브 마이크로플로우로 이름 붙일 수 있습니다.

첫 번째 서브 마이크로플로우 후에 결정 노드를 추가하여 종료 이벤트로 연결되도록 하세요. 그렇지 않으면 종속성 서브 마이크로플로우가 채워지지 않은 날짜와 비교하거나 선택되지 않은 날짜를 검색하려고 시도할 때 원하지 않는 오류가 발생할 수 있습니다.

'Parameter 'Valid' cannot be changed'라는 오류가 발생할 수 있습니다. 이는 서브 마이크로플로우 내에서 원시 입력 매개변수(부울, 정수, 날짜/시간 등)를 변경할 수 없기 때문입니다. 주요 마이크로플로우의 결정 이후이므로 새 변수를 생성하여 사용하는 것이 좋습니다. 이 부분은 이전의 모든 검사가 유효한 경우에만 도달할 수 있습니다.

'VAL_ProgramItem_Dependencies' 서브 마이크로플로우는 다음과 같을 것입니다:
![image](https://github.com/user-attachments/assets/302da8bf-ff46-4ec0-a760-dfe0dabb370d)

**참고:** 여러 수준의 서브 마이크로플로우를 사용하는 것은 혼란을 초래할 수 있으므로 과용하지 않도록 주의하세요. 최선의 방법은 최대 2-3 수준으로 유지하는 것입니다.

# 앱의 유지 보수성 향상(maintainability)
### 문서화가 필요한 이유
- 기능을 추적하고 왜 그렇게 구축했는지 기록하는 것은 좋은 실천입니다. 이는 미래의 자신뿐만 아니라 팀원들에게도 도움이 됩니다. 이를 위해 문서화를 활용하는 것이 좋은 방법입니다.
- Mendix에서는 마이크로플로우나 도메인 모델의 속성, 특정 엔티티의 속성 등 여러 위치에 문서화를 추가할 수 있습니다. 이는 팀 변경 시 모델이 잘 구조화되고, 유지 관리가 용이하며, 배우기 쉬운 모델을 만드는 데 도움이 됩니다.
### 문서화를 할 때 주의사항
- 그러나 문서화가 빠르게 오래될 수 있다는 점을 염두에 두는 것이 중요합니다.
- 따라서 충분히 문서화하여 가치를 더하면서도, 과도한 문서화로 인해 비용이 발생하거나 빠르게 무의미해지지 않도록 균형을 맞추는 것이 중요합니다.

### 주석
- 유지 보수성을 위해 주석을 추가하는 것이 좋습니다.
- 시간이 지남에 따라 마이크로플로우로 무엇을 시도했는지 잊어버릴 수 있습니다.
- 새로운 팀원들이 당신이 만든 마이크로플로우에서 작업할 때, 잘 구조화되고 문서화된 경우 작업이 훨씬 쉬워질 것입니다.
- 주석의 문서화 수준은 중요하며, 정보가 관련성이 있으면서도 너무 길지 않도록 하여 모든 사소한 변경에 따라 업데이트해야 하는 상황을 피하는 것이 좋습니다.

## 1. 주석 추가하기
이를 실천에 옮기기 위해, 유효성 검사 서브 마이크로플로우에 주석을 추가해 보겠습니다.
다음 서브 마이크로플로우에 주석을 추가하세요:
- **VAL_ProgramItem_RequiredInfo**: 이 마이크로플로우는 모든 필수 정보가 추가되었는지 검증합니다.
- **VAL_ProgramItem_Dependencies**: 이 마이크로플로우는 속성과 선택된 참조 간의 종속성을 검증합니다.
![image](https://github.com/user-attachments/assets/86856f8d-ea90-403f-924d-388b14a35d0e)


# 재사용성 향상
### 규칙
- Mendix에서는 마이크로플로우와 매우 유사한 또 다른 유형의 문서인 규칙(rule)이 있습니다. 규칙은 그 존재의 특성상 기능이 제한되어 있습니다.
- 규칙은 주로 데이터를 평가하고 그 평가를 기반으로 결과를 반환하는 데 사용됩니다.
  - 마이크로플로우도 같은 목적으로 사용할 수 있지만, 추가로 삭제, 커밋, 통합 작업 호출, 클라이언트 상호작용 등 훨씬 많은 기능을 지원합니다.
### 규칙에 활용 가능한 활동 유형
규칙의 제한은 사용자가 선택하는 활동에 따라 달라집니다. 규칙 내에서 사용할 수 있는 활동 유형은 다음과 같습니다:
- 객체 캐스팅 (Cast object)
- 검색 (Retrieve)
- 목록 집계 (Aggregate list)
- 목록 변경 (Change list)
- 목록 생성 (Create list)
- 목록 작업 (List operation)
- 자바 액션 호출 (Java action call)
- 마이크로플로우 호출 (Microflow call)
- 변수 변경 (Change variable)
- 변수 생성 (Create variable)
- 로그 메시지 (Log message)

이 외에도 규칙은 입력 매개변수, 루프, 조건 분기 등을 사용할 수 있으며, 이는 마이크로플로우와 유사합니다.

### 문서 제외하기
- 때때로 프로젝트에서 더 이상 사용하지 않으려는 문서를 유지하는 것이 유용할 수 있습니다.
  - 예를 들어, 구조를 변경하려고 하고 모든 오래된 기능이 커버되었는지 확인할 때입니다.
- 문서를 제외하면 Mendix Studio Pro에서 더 이상 평가되지 않지만 문서의 모든 내용을 여전히 볼 수 있습니다.
- 문서를 삭제하는 대안도 있지만, 이 경우 더 이상 문서를 볼 수 없습니다.

### 문서가 적용되는 곳
- 문서 제외는 마이크로플로우뿐만 아니라 페이지, 열거형, 스니펫 등 모든 문서 유형에 적용됩니다.
- 문서를 제외하려면 앱 탐색기에서 문서를 선택하고 마우스 오른쪽 버튼을 클릭한 후 '프로젝트에서 제외(Exclude from project)'를 사용하면 됩니다.

## 1. 규칙 및 문자열 검증
### 1.1 문자열 검증
- 데이터 타입 String을 검증하는 방식부터 시작하겠습니다.
  - 예를 들어, $ProgramItem/Title != empty와 같이 검증했을 수 있습니다.
  - 그러나 이 방법은 하나 이상의 공백 또는 값이 입력되었다가 나중에 지워진 경우를 포함하지 않습니다.
  - Mendix에서 문자열의 기본 값은 empty이지만, 이는 ' '와는 다릅니다. 빈 문자열은 초기 설정값이며, ' ' 문자열은 사용자가 기존의 값을 지우면서 생성할 수 있습니다.
- 모든 String 데이터 타입을 검증하기 위해 재사용 가능한 규칙을 구축할 것입니다.

### 1.2 규칙 생성
1. **규칙 생성**: 프로젝트 탐색기에서 규칙을 생성하고 이를 `VALStringNotEmpty`라고 명명합니다. 모듈 폴더에서 오른쪽 클릭한 후 `Add other > Rule`을 선택하여 추가합니다. 이 마이크로플로우의 반환 타입이 Boolean으로 설정되어 있는지 확인합니다. 규칙은 Boolean 또는 Enumeration을 반환해야 합니다.</br>
![image](https://github.com/user-attachments/assets/daa98d97-76ef-4a32-88c7-eee9c46bc295)
![image](https://github.com/user-attachments/assets/7dc8f0c4-3ac8-4e6d-ba4b-b86730cd0175)
3. **입력 매개변수 추가**: 규칙에 문자열 타입의 입력 매개변수를 추가하고 이를 `InputString`이라고 명명합니다. </br>
![image](https://github.com/user-attachments/assets/03af50ab-1475-45f8-b5a8-afbe9fd63d5d)
4. **조건 분기 추가**: 규칙에 두 가지 조건을 확인하는 분기 조건을 추가합니다:
   - 문자열이 비어 있지 않은지 확인
   - 문자열이 지워지지 않았거나 공백만으로 구성되어 있는지 확인
   이를 확인하기 위해 표현식 `trim($InputString) != ''`을 사용합니다.
5. **결과 시퀀스 정의**: 결과가 true 또는 false이므로 두 개의 시퀀스 흐름을 정의합니다. true 결과에 대한 기존 시퀀스 흐름을 사용하고, 이를 왼쪽에서 오른쪽으로 설정하여 ‘행복한’ 경로로 설정합니다. 반환 값은 자동으로 true로 설정됩니다.
   다음으로 두 번째 시퀀스 흐름을 생성하고 두 번째 End Event로 연결합니다. 이 시퀀스 흐름은 자동으로 false로 표시되며 반환 값은 false로 설정됩니다. Mendix Studio Pro는 가능한 옵션을 평가하고 하나의 옵션이 남았을 때 자동으로 채워집니다. 완성된 규칙은 아래 이미지와 비슷해야 합니다.

### 1.3 규칙 사용
규칙을 생성한 후, 이제 이를 사용하는 방법을 살펴보겠습니다.

**VAL_ProgramItem_RequiredInfo 서브 마이크로플로우에서 규칙 사용하기**

1. VAL_ProgramItem_RequiredInfo 서브 마이크로플로우를 열어 규칙을 구현할 방법을 확인합니다. 문자열 데이터 타입을 평가하는 두 개의 Decision이 있습니다: Title과 Description.

2. 첫 번째 Decision을 열면 Decision Type을 정의할 수 있는 옵션이 있습니다. 기본값은 Expression이지만, 이제 이를 Rule로 변경하여 정의된 규칙을 사용할 수 있습니다.

3. 규칙을 선택할 수 있는 옵션이 제공되며, 선택할 규칙을 알고 있어야 합니다.

4. 입력 매개변수에 대한 인수를 정의하면 완료됩니다.

이 작업을 두 번째 문자열 속성에 대해 반복합니다.

이제 모든 String 속성이 동일한 방식으로 빈 값이 체크되도록 하는 규칙을 재사용했습니다. 마이크로플로우도 동일한 방식으로 재사용할 수 있음을 상상할 수 있습니다.

# 퀴즈
### Question 1: What is a limitation of a sub-microflow compared to a regular microflow?
**한국어 번역**: 일반 마이크로플로우에 비해 서브 마이크로플로우의 제한은 무엇인가요?

- **정답**: None. Sub-microflows are equally capable.
- **틀린 답변 해설**:
  - "Branching is not possible."는 틀린 답변입니다. 서브 마이크로플로우에서도 분기가 가능합니다.
  - "You have a smaller selection of activities."는 틀린 답변입니다. 서브 마이크로플로우도 일반 마이크로플로우와 비슷한 활동을 수행할 수 있습니다.
  - "A sub-microflow may only return a Boolean."는 틀린 답변입니다. 서브 마이크로플로우는 다양한 값을 반환할 수 있습니다.

---

### Question 2: What main benefit do sub-microflows offer?
**한국어 번역**: 서브 마이크로플로우의 주요 이점은 무엇인가요?

- **정답**: Better maintainability.
- **틀린 답변 해설**:
  - "Increased logical capability"는 틀린 답변입니다. 서브 마이크로플로우는 복잡한 논리를 확장하지 않으며, 기능적 논리에서 차이가 없습니다.
  - "Smaller memory usage"는 틀린 답변입니다. 메모리 사용량의 차이는 없습니다.
  - "Improved performance"는 틀린 답변입니다. 성능이 크게 개선되지는 않습니다.

---

### Question 3: If you want to leave notes for future developers (or yourself) in a microflow, what can you use?
**한국어 번역**: 마이크로플로우에 향후 개발자(또는 자신)를 위한 메모를 남기고 싶다면 무엇을 사용할 수 있나요?

- **정답**: Annotations.
- **틀린 답변 해설**:
  - "Comments"는 틀린 답변입니다. 마이크로플로우에서 직접 코멘트를 추가할 수 없습니다.
  - "Sticky notes"는 틀린 답변입니다. Sticky notes 기능은 없습니다.
  - "Captions"는 틀린 답변입니다. Captions은 주석 기능이 아닙니다.

---

### Question 4: What is a limitation of a rule compared to a microflow?
**한국어 번역**: 마이크로플로우에 비해 규칙의 제한은 무엇인가요?

- **정답**: You have a smaller selection of activities.
- **틀린 답변 해설**:
  - "A rule may only return a Boolean."는 틀린 답변입니다. 규칙이 Boolean을 반환하는 것이 주 기능일 뿐, 규칙이 마이크로플로우와 동일한 작업을 수행할 수 있는지 여부는 다릅니다.
  - "None. Rules are equally capable."는 틀린 답변입니다. 규칙은 마이크로플로우에 비해 여러 면에서 제한적입니다.
  - "Branching is not possible."는 틀린 답변입니다. 규칙에서도 간단한 분기는 가능합니다.

---

### Question 5: You’ve replaced a microflow with newer functionality and want to test it. However, you don’t want to delete the old microflow permanently in case something goes wrong. How can you do this?
**한국어 번역**: 마이크로플로우를 새로운 기능으로 대체했지만 문제가 생길 경우를 대비해 기존 마이크로플로우를 영구적으로 삭제하고 싶지 않습니다. 어떻게 해야 하나요?

- **정답**: Exclude it from the project.
- **틀린 답변 해설**:
  - "Rename it."는 틀린 답변입니다. 이름을 변경하는 것만으로는 기능이 비활성화되지 않습니다.
  - "Deactivate it."는 틀린 답변입니다. 마이크로플로우를 비활성화하는 기능은 없습니다.
  - "Soft delete to the recycle bin and restore later."는 틀린 답변입니다. Mendix에서 제공하는 기능이 아닙니다.
